{{!-- <script>
    const retryPayment = document.getElementById("retryPayment");
    retryPayment.addEventListener('click',function(){
        const totalPrice = document.getElementById("totalPrice").value
    })
</script> --}}

<body>
    <main class="main">
        <section class="pt-150 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 m-auto">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        {{!-- <li class="nav-item">
                                            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false"><i class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                        </li> --}}
                                        <li class="nav-item">
                                            <a class="nav-link active" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false"><i class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true"><i class="fi-rs-marker mr-10"></i>My Address</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail" role="tab" aria-controls="account-detail" aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="tab-content dashboard-content">

                                    {{!-- orders list page --}}
                                    <div class="tab-pane fade active show" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">My Orders</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                {{!-- <th>Product</th> --}}
                                                                <th>Date</th>
                                                                <th>Total</th>
                                                                <th>Payment method</th>
                                                                <th>Payment status</th>
                                                                <th>Details</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {{#each dateFormattedOrders}}
                                                            <tr>
                                                                {{!-- <td>#1357</td> --}}
                                                                <input type="text" value="{{this._id}}" id="orderId" hidden>
                                                                <input type="text" value="{{this.totalPrice}}" id="totalPrice" hidden>
                                                                <td>{{this.date}}</td>
                                                                <td>Rs. {{this.totalPrice}}</td>
                                                                <td>{{this.paymentMethod}}</td>
                                                                {{#ifEquals this.paymentStatus "payed"}}
                                                                <td><span class="badge rounded-pill text-bg-success">{{this.paymentStatus}}</span></td>
                                                                {{/ifEquals}}
                                                                {{#ifEquals this.paymentStatus "COD"}}
                                                                <td><span class="badge rounded-pill text-bg-warning">{{this.paymentStatus}}</span></td>
                                                                {{/ifEquals}}
                                                                {{#ifEquals this.paymentStatus "pending"}}
                                                                <td><span class="btn badge text-bg-danger"><a id="retryPayment" onclick="retryPayment('{{this._id}}','{{this.totalPrice}}')">Payment failed, Try again</a></span></td>
                                                                {{/ifEquals}}
                                                                <td><a href="/orderDetails/{{this._id}}" class="btn-small d-block badge text-bg-primary" style="text-decoration: none;">View</a></td>
                                                            </tr>
                                                            {{/each}}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {{!-- ---------------------------------------------------------------------------------------- --}}

                                    {{!-- order tracking page --}}
                                    <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Orders tracking</h5>
                                            </div>
                                            <div class="card-body contact-from-area">
                                                <p>To track your order please enter your OrderID in the box below and press "Track" button. This was given to you on your receipt and in the confirmation email you should have received.</p>
                                                <div class="row">
                                                    <div class="col-lg-8">
                                                        <form class="contact-form-style mt-30 mb-50" action="#" method="post">
                                                            <div class="input-style mb-20">
                                                                <label>Order ID</label>
                                                                <input name="order-id" placeholder="Found in your order confirmation email" type="text" class="square">
                                                            </div>
                                                            <div class="input-style mb-20">
                                                                <label>Billing email</label>
                                                                <input name="billing-email" placeholder="Email you used during checkout" type="email" class="square">
                                                            </div>
                                                            <button class="submit submit-auto-width" type="submit">Track</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {{!-- --------------------------------------------------------------------------------------------------- --}}

                                    {{!-- address page --}}
                                    <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                        <a href="/addAddress" class="btn btn-primary ms-auto mb-5" style="width: auto;">Add New Address</a>
                                        <div class="row">
                                            {{#if addresses}}
                                            {{#each addresses}}
                                            {{#if this.isActive}}
                                            <div class="col-lg-6 mb-3">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">Shipping Address</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <address>{{this.name}}<br>
                                                            {{this.mobileNumber}}<br>{{this.address}}<br>{{this.city}},{{this.state}} <br>{{this.pinCode}}
                                                        </address>
                                                        <a href="/editAddress/{{this._id}}" class="btn-small me-5">Edit</a>
                                                        <a href="/deleteAddress/{{this._id}}" class="btn-small" style="margin-left: 50%;">Delete</a>
                                                    </div>
                                                </div>
                                            </div>
                                            {{/if}}
                                            {{/each}}
                                            {{else}}
                                            <div class="col-lg-6 mb-3">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">Shipping Address</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <h5>No address found</h5>
                                                    </div>
                                                </div>
                                            </div>
                                            {{/if}}
                                        </div>
                                    </div>
                                    {{!-- ------------------------------------------------------------------------------------------------------------ --}}

                                    {{!-- account details --}}
                                    <div class="tab-pane fade" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Account Details</h5>
                                            </div>
                                            <div class="card-body">
                                                    <div class="row">
                                                        <div class="form-group col-md-12">
                                                            <label>Full name</label>
                                                            <input disabled required class="form-control square" name="name" type="text" value="{{user.name}}">
                                                        </div>
                                                        <div class="form-group col-md-12">
                                                            <label>Email Address</label>
                                                            <div>
                                                                <input disabled required class="form-control square" name="email" type="email" value="{{user.email}}">
                                                                <a href="/editEmail/{{user._id}}" class="btn btn-primary col-md-3 my-2">Edit Email</a>
                                                            </div>
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <label>Mobile number</label>
                                                            <input disabled required class="form-control square" name="mobileNumber" pattern="[0-9]{10}" type="text" value="{{user.mobilenumber}}">
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <label>My referral code</label>
                                                            <input disabled required class="form-control square" name="refferalCode" type="text" value="{{referralCode}}">
                                                            <span class="text-info-emphasis">(Share this refferal code to get Rs.100 to your wallet, when user place the first order)</span>
                                                        </div>
                                                        <div class="col-md-12 mb-3 text-center" style="background-color: firebrick;color: white;font-weight: bolder;">
                                                            <label>My referral Link: </label>
                                                            <a href="/register?referralCode={{referralCode}}" class="link-warning link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">/register?referralCode={{referralCode}}</a>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-around">
                                                        <a href="/editDetails/{{user._id}}" class="btn btn-primary me-2 mb-3 col-md-4" >Edit details</a>
                                                        <a href="/changePassword/{{user._id}}" class="btn btn-primary mb-3 col-md-4">Change Password</a>
                                                    </div>
                                                
                                            </div>
                                        </div>
                                    </div>
                                    {{!-- ----------------------------------------------------------------------------------------------------------- --}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!-- Vendor JS-->
    <script src="assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="assets/js/plugins/slick.js"></script>
    <script src="assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="assets/js/plugins/wow.js"></script>
    <script src="assets/js/plugins/jquery-ui.js"></script>
    <script src="assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="assets/js/plugins/magnific-popup.js"></script>
    <script src="assets/js/plugins/select2.min.js"></script>
    <script src="assets/js/plugins/waypoints.js"></script>
    <script src="assets/js/plugins/counterup.js"></script>
    <script src="assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="assets/js/plugins/images-loaded.js"></script>
    <script src="assets/js/plugins/isotope.js"></script>
    <script src="assets/js/plugins/scrollup.js"></script>
    <script src="assets/js/plugins/jquery.vticker-min.js"></script>
    <script src="assets/js/plugins/jquery.theia.sticky.js"></script>
    <!-- Template  JS -->
    <script src="assets/js/main.js"></script>
</body>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    async function retryPayment(orderId,totalPrice){
        try{
            console.log("called");
            console.log(orderId,totalPrice);
            const response = await fetch('/retryPayment',{
                method:'POST',
                headers:{
                    'Content-Type':'application/json'
                },
                body:JSON.stringify({orderId,totalPrice})
            })
            const data = await response.json();
            console.log("data:",data);
            const options = {
                "key" : data.razorpayKey,
                "amount" : data.order.amount,
                "currency" : 'INR',
                "name" : "UFO",
                "order_id" : data.order.id,
                "handler" : function (response){
                        
                    if(response.razorpay_payment_id){
                        console.log("response.razorpay_payment_id",response.razorpay_payment_id);
                        console.log("response:",response);
                        fetch('/verifyPayment',{
                            method:'POST',
                            headers:{
                                'Content-Type':'application/json'
                            },
                            body:JSON.stringify({response,orderId:data.orderId})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if(data.success){
                                window.location.href = '/orderSuccess';
                            }else if(!data.success){
                                window.location.href = '/orderFailed';
                            }
                        })
                    }
                }
            }
            const rzp1 = new Razorpay(options);
            rzp1.on('payment.failed',function(response){
                window.location.href = '/orderFailed';
            })
            rzp1.open();
        }catch(err){
            console.log("Error on retry payment:",err.message);
        }
    }
</script>