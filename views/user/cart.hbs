<main class="main">
  <section class="mt-50 mb-50">
    <div class="container">
      <div class="row">
        <div class="col-12">
          {{#if userCart.products}}
            <div class="table-responsive">
              <table class="table shopping-summery text-center clean">
                <thead>
                  <tr class="main-heading">
                    <th scope="col">Image</th>
                    <th scope="col">Name</th>
                    <th scope="col">Price</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Remove</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each userCart.products}}
                    <tr>
                      <td class="image"><a
                          href="/productDetails/{{this.productId._id}}"
                        ><img
                            src="{{this.productId.images.[0]}}"
                            alt="prodImg"
                          /></a></td>
                      <td class="product-des">
                        <h5 class="product-name"><a
                            href="/productDetails/{{this.productId._id}}"
                            style="text-decoration: none; color: black;"
                          >{{this.productId.productName}}</a></h5>
                        <p class="font-s">{{this.productId.brandName}}<br />
                        </p>
                      </td>
                      <td class="price" data-title="Price"><span>
                        Rs.{{this.productId.offerPrice}}  
                        </span>
                      </td>
                      <td class="text-center" data-title="Stock">
                        <div class="col-md-3 quantity m-auto d-flex">
                            <button class="btn-sm btn-outline-secondary" value="{{this.productId._id}}" onclick="decreaseQuantity(this)">-</button>
                            <input
                            id="{{this.productId._id}}"
                            type="number"
                            min="1"
                            max="{{this.productId.stock}}"
                            class="form-control quantity-input quantity-display mt-3 ms-2 me-2"
                            oninput="checkValue(this)"
                            value="{{this.quantity}}"
                            readonly
                          />
                            <button class="btn-sm btn-outline-secondary" value="{{this.productId._id}}" onclick="increaseQuantity(this)">+</button>
                        </div>
                      </td>
                      <td class="action" data-title="Remove"><a
                          href="/removeCartItem/{{this.productId._id}}"
                          class="text-muted" 
                          onclick="return confirm(`Are you sure to remover this product from cart?`)"
                        ><i class="bi bi-trash-fill"></i></a></td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
            <div class="cart-action text-end">
              <a class="btn btn-primary" href="/products"><i
                  class="fi-rs-shopping-bag mr-10"
                ></i>Continue Shopping</a>
            </div>
            <div class="divider center_icon mt-50 mb-50"><i
                class="fi-rs-fingerprint"
              ></i></div>
            <div class="row mb-50">
              <div class="col-lg-6 col-md-12">
                <div class="mb-30 mt-50">
                  {{!-- <div class="heading_s1 mb-3">
                    <h4>Apply Coupon</h4>
                  </div> --}}
                  <div class="total-amount">
                    <div class="left">
                      {{!-- <div class="coupon">
                        <form action="#" target="_blank">
                          <div class="form-row row justify-content-center">
                            <div class="form-group col-lg-6">
                              <input
                                class="font-medium"
                                name="Coupon"
                                placeholder="Enter Your Coupon"
                              />
                            </div>
                            <div class="form-group col-lg-6">
                              <button class="btn btn-sm btn-secondary"><i
                                  class="fi-rs-label mr-10"
                                ></i>Apply</button>
                            </div>
                          </div>
                        </form>
                      </div> --}}
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6 col-md-12">
                <div class="border p-md-4 p-30 border-radius cart-totals">
                  <div class="heading_s1 mb-3">
                    <h4>Cart Totals</h4>
                  </div>
                  <div class="table-responsive">
                    <table class="table">
                      <tbody>
                        <tr>
                          <td class="cart_total_label">Cart Subtotal</td>
                          <td class="cart_total_amount"><span
                              class="font-lg fw-900 text-brand" id="subtotal"
                            ><i class="bi bi-currency-rupee"></i> {{subTotal}}</span></td>
                        </tr>
                        <tr>
                          <td class="cart_total_label">Shipping</td>
                          <td class="cart_total_amount">
                            <i class="ti-gift mr-5"></i>
                            Free Shipping</td>
                        </tr>
                        <tr>
                          <td class="cart_total_label">Total</td>
                          <td class="cart_total_amount"><strong><span
                                class="font-xl fw-900 text-brand" id="total"
                              ><i class="bi bi-currency-rupee"></i> {{subTotal}}</span></strong></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <a href="/checkout" class="btn btn-success">
                    <i class="fi-rs-box-alt mr-10"></i>
                    Proceed To CheckOut</a>
                </div>
              </div>
            </div>
          {{else}}
            <div class="cart-action text-center">
              <h2 class="mb-4">Your cart is empty!</h2>
              <a class="btn btn-primary" href="/"><i
                  class="fi-rs-shopping-bag mr-10"
                ></i>Continue Shopping</a>
            </div>
          {{/if}}
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  function increaseQuantity(element){
    console.log("element: ",element);
    let quantityInput = element.parentElement.querySelector('input');
    let currentQuantity = parseInt(quantityInput.value);
    let maxStock = parseInt(quantityInput.max);

    if(currentQuantity<maxStock){
      quantityInput.value = currentQuantity + 1;
      updateQuantityInCart(quantityInput.value,element.value);
    }else{
      alert("No more stock is available for this product!!!");
    }
  }

  function decreaseQuantity(element){
    let quantityInput = element.parentElement.querySelector('input');
    let currentQuantity = parseInt(quantityInput.value);

    if(currentQuantity>1){
      quantityInput.value = currentQuantity - 1;
      updateQuantityInCart(quantityInput.value,element.value);
    }else{
      alert("Quantity can't be less than one");
    }
  }

  function updateQuantityInCart(newQuantity,id){
    const data = {productId : id, quantity : newQuantity};
    //AJAX request to update the quantity in the cart
    fetch('/updateCartQuantity',{
      method: 'POST',
      headers: {
        'Content-Type' : 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      return response.json();
      })
    .then(data => {
      updatedQuantity = data.data.quantity;
      const prodId = data.data.productId;
      const quantityInput = document.getElementById(prodId); 
      quantityInput.value = updatedQuantity;
      const subtotal = document.getElementById('subtotal');
      const total = document.getElementById('total');
      subtotal.innerText = data.data.subtotal;
      total.innerText = data.data.subtotal;
    })
    .catch((err) => console.log("Error: ",err));
  }
</script>